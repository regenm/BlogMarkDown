---
title: 计算机网络-证书理解
date: 2025-07-17 9:21:41
tags: [计算机网络,笔记,证书]
categories: [软硬件技术]
---

证书是**非常核心也非常实用**的东西，尤其是做 LDAP、SSO、HTTPS、MQTT 之类的服务都会涉及到。

------

## 一、什么是证书

证书（通常是 X.509 格式）本质是一个带有数字签名的数据结构，用来**证明某个公钥属于某个主体（如域名、组织）**。

- 包含：主体信息（如 CN=[www.example.com）、公钥、签发者信息、有效期、用途（Key](http://www.example.xn--com)(key-im3gaaa2917h7re0wkvu6c2hr5gh8lal90v711at2u0n8fi5wa/) Usage / Extended Key Usage）、数字签名等
- 目的是让客户端通过验证签名来**信任这个公钥**确实属于目标服务

------

## 二、证书的信任体系

1. 自签名证书：自己生成公私钥并自己签名，只能在内部或测试中用，需要客户端手动信任
2. CA 签发证书：向受信任的证书颁发机构（CA）申请，由 CA 使用它的私钥签名，全世界的客户端默认信任

> **受信任的证书颁发机构是什么？**
>
> **我自己搭建的winserver增加CA角色并导出的根证书有什么用？**
>
> **CA服务器可以是对的对吗？**
>
> ## 1. 什么是 CA 和根证书
>
> - CA（证书颁发机构）是一个专门用来签发证书的角色
> - 公共 CA（DigiCert 等）默认在操作系统/浏览器里就被信任
> - 自建 CA（比如你在 WinServer 上加的 CA 角色）需要手动把导出的根证书导入客户端系统，客户端才会信任它签发的证书
>
> ------
>
> ## 2. 自建 CA 的作用
>
> - 核心目的：让客户端信任**由这个 CA 签发的所有服务端证书**（例如 LDAP、Web 服务）
> - 客户端并不需要访问 CA 服务器本身，只需要信任它的根证书
>
> ------
>
> ## 3. TLS 握手和证书的关系
>
> - 客户端连接服务（如 LDAP over TLS）时，会通过 TLS 握手验证服务端证书
> - 验证包括：
>     - 服务端证书是由已信任的 CA 签发的
>     - CN/SAN 是否匹配实际访问的域名
>     - 证书链是否完整
> - 自建 CA 的根证书必须导入客户端受信任根证书列表，否则握手会失败
>
> ------
>
> ## 4. 关键点总结
>
> - CA 服务器只负责签发证书，不需要跟服务端 IP 相同，也不需要客户端访问
> - 客户端只要信任根证书，就会信任这个 CA 签发的所有证书
> - TLS 握手核心作用：验证身份并协商加密
>
> > # 举例
> >
> > ## 用自建CA实现正常HTTPS访问示例（服务器A做CA，服务器B做Web）
> >
> > ### 环境
> >
> > - 服务器A：搭建自建CA，生成根证书和CA私钥
> > - 服务器B：用服务器A的CA签发HTTPS证书，配置Web服务器（如nginx、Apache）
> > - 客户端：访问服务器B的HTTPS网页
> >
> > 1. **搭建自建CA服务器（服务器A）**，生成根证书和私钥。
> > 2. **用CA给服务器B的Web服务生成并签发证书**（包含正确的域名信息）。
> > 3. **服务器B部署该证书和私钥，配置HTTPS服务。**
> > 4. **客户端导入服务器A的根证书**，将其加入受信任根证书列表。
> > 5. **客户端用与证书匹配的域名访问服务器B的HTTPS网站**，完成TLS握手并建立安全连接。
> >
> > 关键点是：
> >
> > - 客户端必须信任你自建的CA根证书，
> > - 访问时域名要和证书一致，
> > - 服务器B配置证书链完整。

证书通常由根证书和中间证书组成一条**证书链**。客户端只要信任根证书，就能通过链验证服务端证书。

------

## 三、TLS 握手与证书的作用

使用证书的方式就是通过**TLS 握手**实现的。TLS 握手流程大致如下：

1. 客户端发送 Client Hello：告知支持的加密算法、TLS 版本、随机数等
2. 服务端发送 Server Hello：选定加密算法、返回服务端证书（带公钥）、随机数
3. 客户端验证服务端证书：检查证书是否在信任列表（CA 根证书）、证书是否过期、CN/SAN 是否匹配实际访问域名、证书链是否完整
4. 客户端生成预主密钥（pre-master secret），用服务端公钥加密发送给服务端
5. 服务端用自己的私钥解密，得到预主密钥
6. 双方基于随机数和预主密钥生成对称密钥，后续通信用对称加密

如果配置了双向认证（Mutual TLS），客户端也会在握手中发送自己的证书，服务端验证客户端身份。

> **OpenSSL 和 GnuTLS** 
>
> * 都是开源的 SSL/TLS 加密库。
>
> - **OpenSSL** 功能强大、兼容性好，工具成熟且宽容，处理证书链和握手更灵活，连接更容易成功。
> - **GnuTLS** 更加严格和标准化，对证书链和配置要求高，安全策略保守，配置不完善时连接容易失败。

------

## 四、常见实际问题

即使导入了信任系统，也可能连接不成功，原因包括：

1. 服务端证书 **CN/SAN 与客户端访问的主机名或域名**不一致

    > 遇到过签发证书只包含域名sAN，而客户端只能通过IP访问的情况
    >
    > 我的解决方式：
    >
    > 1. 直接修改客户端hosts，因为只有一个客户端（内网提供其他服务）。本地修改一次即可继续为其他客户端提供服务。
    > 2. 如果是openssl可以通过一些手段放宽验证以实现TLS握手。例如`TLS_CIPHER_SUITE NORMAL`以及`TLS_REQCERT allow # or TLS_REQCERT never`

2. 服务端证书是中间 CA 签发，但客户端只导入根证书，缺少中间证书

3. 服务端证书用途（Key Usage / Extended Key Usage）不包含 Server Authentication

4. 服务端配置证书链不完整（只返回了单个证书，没有带中间证书）

5. 如果服务端启用了双向认证，客户端没有提供证书

------

## 五、常见工具

- openssl：查看、生成、验证证书，排查握手问题
- keytool：管理 Java keystore 和 truststore
- certbot：申请 Let's Encrypt 免费证书
- 浏览器：查看证书链和信任情况

------

## 六、排查思路

1. 用 openssl s_client -connect server:port -showcerts 看服务端返回的证书链是否完整，验证是否信任
2. 检查证书的 CN/SAN 是否和实际访问的域名一致
3. 确保客户端 truststore 中导入了正确的根证书（有时还要导入中间证书）
4. 确认服务端配置的证书文件包含完整的证书链（server cert + intermediate cert）
5. 如果服务端需要客户端证书，确认客户端是否配置

------

## 七、总结

- TLS 握手核心目的是：验证身份 + 协商对称密钥
- 证书的核心作用是把公钥和身份绑定，并且让别人信任
- 常见的连接失败，多数不是“没有导入信任”，而是：证书链不完整、域名不一致、用途不对或缺少客户端证书等

